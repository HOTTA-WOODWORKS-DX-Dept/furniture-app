import streamlit as st
import requests
import json
import base64
import io
from PIL import Image

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(page_title="Room AI Studio Pro", layout="wide")
st.title("ğŸ›‹ï¸ Room AI Studio (Pro)")
st.caption("Gemini 2.0 Flash (Vision) Ã— Imagen 4.0 (Generation)")

# --- APIã‚­ãƒ¼ç¢ºèª ---
try:
    api_key = st.secrets["GEMINI_API_KEY"]
except:
    st.error("Secretsã«APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    st.stop()

# --- ç”»åƒå‡¦ç†é–¢æ•° ---
def image_to_base64(uploaded_file):
    # ç”»åƒã‚’å°‘ã—å°ã•ãã—ã¦é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
    img = Image.open(uploaded_file)
    img.thumbnail((800, 800))
    # JPEGå¤‰æ›
    buffered = io.BytesIO()
    img.save(buffered, format="JPEG", quality=80)
    # Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    return base64.b64encode(buffered.getvalue()).decode('utf-8')

# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ ---
col1, col2 = st.columns([1, 1.2])

with col1:
    st.subheader("1. å®¶å…·ã‚’æ’®å½±")
    uploaded_file = st.file_uploader("å®¶å…·ã®å†™çœŸ", type=["jpg", "png", "jpeg"])
    if uploaded_file:
        st.image(uploaded_file, width=300, caption="è§£æå¯¾è±¡")

with col2:
    st.subheader("2. ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆè¨­å®š")
    room = st.selectbox("éƒ¨å±‹", ["ãƒªãƒ“ãƒ³ã‚°", "ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°", "å¯å®¤", "ã‚ªãƒ•ã‚£ã‚¹", "ã‚«ãƒ•ã‚§"])
    style = st.selectbox("ã‚¹ã‚¿ã‚¤ãƒ«", ["åŒ—æ¬§ãƒ¢ãƒ€ãƒ³", "ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸", "ã‚¤ãƒ³ãƒ€ã‚¹ãƒˆãƒªã‚¢ãƒ«", "å’Œãƒ¢ãƒ€ãƒ³", "ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼"])
    
    st.divider()
    generate_btn = st.button("âœ¨ ç”Ÿæˆã‚¹ã‚¿ãƒ¼ãƒˆ", type="primary")

# --- å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ---
if generate_btn:
    if not uploaded_file:
        st.warning("å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„")
    else:
        status = st.empty()
        status.info("ğŸš€ Gemini 2.0 ãŒå®¶å…·ã‚’è¦‹ã¦ã„ã¾ã™...")
        
        try:
            # 1. Gemini 2.0 Flash ã§å®¶å…·ã‚’åˆ†æ (REST API)
            base64_img = image_to_base64(uploaded_file)
            
            gemini_url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}"
            
            gemini_payload = {
                "contents": [{
                    "parts": [
                        {"text": f"Describe this furniture in detail. Then write a high-quality English prompt for an image generator to place this furniture in a {style} {room}. The room should have cinematic lighting. Output ONLY the prompt text."},
                        {"inline_data": {"mime_type": "image/jpeg", "data": base64_img}}
                    ]
                }]
            }
            
            response_gemini = requests.post(gemini_url, headers={'Content-Type': 'application/json'}, data=json.dumps(gemini_payload))
            
            if response_gemini.status_code != 200:
                st.error(f"Gemini Error: {response_gemini.text}")
                st.stop()
                
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæŠ½å‡º
            prompt_text = response_gemini.json()['candidates'][0]['content']['parts'][0]['text']
            clean_prompt = prompt_text.replace('\n', ' ').strip()
            
            status.info("ğŸ¨ Imagen 4.0 ãŒæç”»ä¸­... (Googleã®æœ€æ–°AIã‚’ä½¿ç”¨)")
            
            # 2. Imagen 4.0 ã§ç”»åƒã‚’ç”Ÿæˆ (REST API)
            # â€»ã“ã“ã§æœ€æ–°ãƒ¢ãƒ‡ãƒ« 'imagen-4.0-generate-001' ã‚’å‘¼ã³å‡ºã—ã¾ã™
            imagen_url = f"https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key={api_key}"
            
            imagen_payload = {
                "instances": [
                    {"prompt": clean_prompt}
                ],
                "parameters": {
                    "sampleCount": 1,
                    "aspectRatio": "4:3"
                }
            }
            
            response_imagen = requests.post(imagen_url, headers={'Content-Type': 'application/json'}, data=json.dumps(imagen_payload))
            
            if response_imagen.status_code == 200:
                result = response_imagen.json()
                
                # ç”»åƒãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šå‡ºã— (Base64ã§è¿”ã£ã¦ãã¾ã™)
                if 'predictions' in result:
                    b64_data = result['predictions'][0]['bytesBase64Encoded']
                    image_data = base64.b64decode(b64_data)
                    final_image = Image.open(io.BytesIO(image_data))
                    
                    status.success("ç”Ÿæˆå®Œäº†ï¼")
                    st.image(final_image, use_container_width=True, caption=f"Generated by Imagen 4.0 ({style})")
                    
                    with st.expander("ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"):
                        st.write(clean_prompt)
                else:
                    st.error("ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚")
                    st.write(result)
            else:
                st.error(f"Imagen Error: {response_imagen.status_code}")
                st.write(response_imagen.text)
                st.info("â€» ã‚‚ã—404ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã€ãƒ¢ãƒ‡ãƒ«åã‚’ 'imagen-3.0-generate-001' ã«å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚")

        except Exception as e:
            st.error(f"ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: {e}")
