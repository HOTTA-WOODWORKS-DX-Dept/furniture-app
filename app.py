import streamlit as st
import google.generativeai as genai
from PIL import Image
import io

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(page_title="Room AI Studio", layout="wide")
st.title("ğŸ›‹ï¸ Room AI Studio (Pro)")
st.caption("Powered by Gemini 2.0 Flash & Imagen 4.0")

# --- APIè¨­å®š ---
try:
    if "GEMINI_API_KEY" in st.secrets:
        api_key = st.secrets["GEMINI_API_KEY"]
        genai.configure(api_key=api_key)
    else:
        st.error("Secretsã« GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        st.stop()
except Exception as e:
    st.error(f"èµ·å‹•ã‚¨ãƒ©ãƒ¼: {e}")
    st.stop()

# --- ãƒ¢ãƒ‡ãƒ«è¨­å®š (è¨ºæ–­ãƒªã‚¹ãƒˆã«åŸºã¥ãæ±ºå®š) ---
# 1. å®¶å…·ã‚’è¦‹ã‚‹ç›® (Vision)
VISION_MODEL_NAME = 'models/gemini-2.0-flash'
# 2. çµµã‚’æãæ‰‹ (Image Generation)
IMAGE_MODEL_NAME = 'models/imagen-4.0-generate-001'

# --- 1033ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼šç”»åƒåœ§ç¸®é–¢æ•° ---
def compress_image(image):
    # ã‚µã‚¤ã‚ºã‚’ã‚¹ãƒãƒ›å†™çœŸ(4000px)ã‹ã‚‰æ‰±ã„ã‚„ã™ã„ã‚µã‚¤ã‚º(800px)ã«
    image.thumbnail((800, 800))
    img_byte_arr = io.BytesIO()
    # JPEGå½¢å¼ã§åœ§ç¸®
    image.save(img_byte_arr, format='JPEG', quality=85)
    img_byte_arr.seek(0)
    return Image.open(img_byte_arr)

# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ ---
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("1. å®¶å…·ã‚’æ’®å½±ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    uploaded_file = st.file_uploader("å®¶å…·ã®å†™çœŸ", type=["jpg", "png", "jpeg"])
    
    if uploaded_file:
        # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        st.image(uploaded_file, width=300, caption="ã“ã®å®¶å…·ã‚’é…ç½®ã—ã¾ã™")

with col2:
    st.subheader("2. ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆè¨­å®š")
    room = st.selectbox("éƒ¨å±‹", ["ãƒªãƒ“ãƒ³ã‚°", "ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°", "å¯å®¤", "ã‚ªãƒ•ã‚£ã‚¹"])
    style = st.selectbox("ã‚¹ã‚¿ã‚¤ãƒ«", ["åŒ—æ¬§ãƒ¢ãƒ€ãƒ³", "ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸", "ã‚¤ãƒ³ãƒ€ã‚¹ãƒˆãƒªã‚¢ãƒ«", "å’Œãƒ¢ãƒ€ãƒ³", "ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼"])
    
    st.divider()
    generate_btn = st.button("âœ¨ ç”Ÿæˆã‚¹ã‚¿ãƒ¼ãƒˆ", type="primary")

# --- ç”Ÿæˆå®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ---
if generate_btn:
    if not uploaded_file:
        st.warning("å®¶å…·ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„")
    else:
        status = st.empty()
        status.info("ğŸš€ Gemini 2.0 ãŒå®¶å…·ã®ç‰¹å¾´ã‚’åˆ†æä¸­...")
        
        try:
            # Step 1: ç”»åƒã®åœ§ç¸®ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
            org_img = Image.open(uploaded_file)
            small_img = compress_image(org_img)
            
            # Step 2: Gemini 2.0 ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
            vision_model = genai.GenerativeModel(VISION_MODEL_NAME)
            
            prompt_instruction = f"""
            Describe the furniture in this image in detail (color, material, shape).
            Then, create a high-quality prompt for an image generator to place this furniture in a {style} {room}.
            The room should have beautiful lighting and realistic details.
            Output ONLY the prompt text in English.
            """
            
            # ç”»åƒã¨æŒ‡ç¤ºã‚’é€ã‚‹
            vision_response = vision_model.generate_content([prompt_instruction, small_img])
            image_prompt = vision_response.text
            
            status.info("ğŸ¨ Imagen 4.0 ãŒç”»åƒã‚’æç”»ä¸­... (ã“ã‚Œã«ã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™)")
            
            # Step 3: Imagen 4.0 ã§ç”»åƒç”Ÿæˆ
            imagen_model = genai.GenerativeModel(IMAGE_MODEL_NAME)
            
            # ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œ
            result = imagen_model.generate_images(
                prompt=image_prompt,
                number_of_images=1,
                aspect_ratio="4:3", # å†™çœŸã‚‰ã—ã„æ¯”ç‡
                safety_filter_level="block_only_high"
            )
            
            # Step 4: çµæœè¡¨ç¤º
            status.success("ç”Ÿæˆå®Œäº†ï¼")
            
            # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’å–ã‚Šå‡ºã—ã¦è¡¨ç¤º
            for img in result.images:
                st.image(img, use_container_width=True, caption=f"Generated by Imagen 4.0 ({style})")
                
            with st.expander("AIãŒä½œæˆã—ãŸæŒ‡ç¤ºæ›¸ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰"):
                st.write(image_prompt)
                
        except Exception as e:
            st.error("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
            st.write(e)
            st.info("ãƒ’ãƒ³ãƒˆ: ç”»åƒç”Ÿæˆ(Imagen)ã¯éå¸¸ã«é«˜åº¦ãªå‡¦ç†ã®ãŸã‚ã€ãŸã¾ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã¦ãã ã•ã„ã€‚")
